###############################################
# RiskApprove - 100% FREE Open Source Stack
# NO PAID APIs (No OpenAI, Gemini, Claude)
###############################################

services:
  mongodb:
    image: mongo:7.0
    container_name: riskapprove-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: riskapprove
    volumes:
      - mongodb_data:/data/db
    networks:
      - riskapprove-network

  # Optional: Ollama for LOCAL LLM inference (completely free & private)
  # Uncomment to enable local LLM support
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: riskapprove-ollama
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   networks:
  #     - riskapprove-network
  #   # Pull mistral model on startup (run once)
  #   # docker exec riskapprove-ollama ollama pull mistral

  ml-service:
    build:
      context: ./ml-service
      dockerfile: Dockerfile
    container_name: riskapprove-ml-service
    ports:
      - "5001:5001"
    environment:
      - FLASK_ENV=production
      - PORT=5001
    networks:
      - riskapprove-network
    depends_on:
      - mongodb

  rag-service:
    build:
      context: ./rag-service
      dockerfile: Dockerfile
    container_name: riskapprove-rag-service
    ports:
      - "5002:5002"
    environment:
      - FLASK_ENV=production
      - PORT=5002
      # FREE embedding model - runs locally, no API key needed!
      - EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      # Alternative FREE models:
      # - sentence-transformers/all-mpnet-base-v2 (better quality)
      # - sentence-transformers/multi-qa-MiniLM-L6-cos-v1 (Q&A optimized)
    volumes:
      - ./regulations:/app/regulations:ro
      - rag_embeddings:/app/embeddings
    networks:
      - riskapprove-network
    depends_on:
      - mongodb

  data-service:
    build:
      context: ./data-service
      dockerfile: Dockerfile
    container_name: riskapprove-data-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - ML_SERVICE_URL=http://ml-service:5001
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
    networks:
      - riskapprove-network
    depends_on:
      - mongodb
      - ml-service

  compliance-service:
    build:
      context: ./compliance-service
      dockerfile: Dockerfile
    container_name: riskapprove-compliance-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - RAG_SERVICE_URL=http://rag-service:5002
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
    networks:
      - riskapprove-network
    depends_on:
      - mongodb
      - rag-service

  portfolio-service:
    build:
      context: ./portfolio-service
      dockerfile: Dockerfile
    container_name: riskapprove-portfolio-service
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
    networks:
      - riskapprove-network
    depends_on:
      - mongodb

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: riskapprove-api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATA_SERVICE_URL=http://data-service:8081
      - COMPLIANCE_SERVICE_URL=http://compliance-service:8082
      - PORTFOLIO_SERVICE_URL=http://portfolio-service:8083
      # FREE LLM Options (choose one):
      # Option 1: HuggingFace Inference API (free tier - 30k requests/month)
      # Get free API key at: https://huggingface.co/settings/tokens
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY:-}
      # Option 2: Ollama for local LLM (uncomment ollama service above)
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=mistral
    networks:
      - riskapprove-network
    depends_on:
      - data-service
      - compliance-service
      - portfolio-service

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: riskapprove-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8080
    networks:
      - riskapprove-network
    depends_on:
      - api-gateway

networks:
  riskapprove-network:
    driver: bridge

volumes:
  mongodb_data:
  rag_embeddings:
  # ollama_data:  # Uncomment if using Ollama
